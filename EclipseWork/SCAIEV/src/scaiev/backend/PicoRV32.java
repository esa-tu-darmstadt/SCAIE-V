package scaiev.backend;

import java.util.HashMap;
import java.util.HashSet;

import scaiev.coreconstr.Core;
import scaiev.frontend.SCAIEVInstr;
import scaiev.util.FileWriter;
import scaiev.util.Lang;
import scaiev.util.ToWrite;
import scaiev.util.VHDL;
import scaiev.util.Verilog;

public class PicoRV32 extends CoreBackend {
	public String tab = "    ";
	HashSet<String> AddedIValid = new HashSet<String>();
	
	public  String 			pathPicoRV32 = "CoresSrc/PicoRV32/";
	private Core 			picorv32;
	private HashMap <String,SCAIEVInstr>  ISAXes;
	private HashMap<String, HashMap<Integer,HashSet<String>>> op_stage_instr;
	private FileWriter 		toFile = new FileWriter();
	private String 			extension_name;
	private Verilog            language = new Verilog(toFile,this);
	private String 			topModule = "picorv32";
	private int nrTabs = 0;
	
	private HashMap <Integer,HashSet<String>> iValidDeclared = new HashMap <Integer,HashSet<String>>();
	private HashSet <Integer> rdInstrDeclared = new HashSet <Integer>();
	
	public void Generate (HashMap <String,SCAIEVInstr> ISAXes, HashMap<String, HashMap<Integer,HashSet<String>>> op_stage_instr, String extension_name, Core core) { // core needed for verification purposes
		// Set variables
		this.picorv32 = core;
		this.ISAXes = ISAXes;
		this.op_stage_instr = op_stage_instr;
		this.extension_name = extension_name;
		language.clk = "clk";
		language.reset = "!resetn";
		ConfigPicoRV32();
		for(int stage = 0 ; stage <=this.picorv32.maxStage;stage ++)
			iValidDeclared.put(stage, new HashSet<String>());
		 // Only for orca, make instr in stage 2 visible, if not used logic will be redundant but also removed as it has no driver 
		 if(!(op_stage_instr.containsKey(BNode.RdInstr) && op_stage_instr.get(BNode.RdInstr).containsKey(2)))
			 language.UpdateInterface(topModule,BNode.RdInstr, "",2,false,false);	
		IntegrateISAX_IOs(topModule);
		IntegrateISAX_NoIllegalInstr();
		IntegrateISAX_RdInstr();
		IntegrateISAX_RdIValid();
		IntegrateISAX_SpawnRD(); // don't switch spawn with wrrd. spawn has priority
		IntegrateISAX_SpawnMem();
		IntegrateISAX_WrRD();
		IntegrateISAX_Mem();
		IntegrateISAX_WrPC();
		IntegrateISAX_WrStall(); // stall last
		
		toFile.WriteFiles(Lang.Verilog);
	
	}
	
	private void IntegrateISAX_IOs(String topModule) {
		 boolean mem_addr = false;
		 boolean reg_addr = false;
		
		 // Generate Interface as for other cores: 
		 language.GenerateAllInterfaces(topModule,op_stage_instr,ISAXes,  picorv32 ,"");
		 
		 // only picorv32 
		 toFile.ReplaceContent(this.ModFile("picorv32"),"output reg [35:0] trace_data", new ToWrite("output reg [35:0] trace_data,",false,true,""));
		 	
		 // only picorv32 workaround syntax err ,
		 this.toFile.UpdateContent(this.ModFile("picorv32"),");",new ToWrite("output dummy_signal",true,false,"module picorv32",true,"picorv32"));
	
	}
	
	
	private void IntegrateISAX_NoIllegalInstr() {
		String isISAXSignal = "ISAX_isisax";
		toFile.ReplaceContent(this.ModFile("picorv32"),"instr_getq, instr_setq, instr_retirq, instr_maskirq",new ToWrite("instr_getq, instr_setq, instr_retirq, instr_maskirq, instr_waitirq, instr_timer, "+isISAXSignal+"};",true,false,"assign instr_trap ="));
		HashSet<String> allISAXes = new HashSet<String>();
		allISAXes.addAll(ISAXes.keySet());
		String logicIsISAX = "always@(posedge "+language.clk+")  begin\n"
				+ tab + "if (mem_do_rinst && mem_done) begin\n"
				+ tab + tab + isISAXSignal + " <= " + language.CreateAllEncoding(allISAXes, ISAXes, "mem_rdata_latched")+";\n"
				+ tab + "end\n"
				+ "end\n";
		addDeclaration("reg "+isISAXSignal+";");
	//	toFile.UpdateContent(this.ModFile("picorv32"),"endmodule",  new ToWrite(logicIsISAX,false,true,"",true));
		addLogic(logicIsISAX);
		
		if(!this.op_stage_instr.containsKey(BNode.WrRD) || (this.op_stage_instr.containsKey(BNode.WrRD)  && (this.op_stage_instr.get(BNode.WrRD).get(this.picorv32.maxStage ).size() < ISAXes.size()) ) ) {
			addDeclaration("wire ISAX_isisax_2;");		
			toFile.ReplaceContent(this.ModFile("picorv32"),"latched_store && !latched_branch", new ToWrite("latched_store && !latched_branch && !ISAX_isisax_2: begin",false,true,""));
			String rdInstr_2 = language.CreateNodeName(BNode.RdInstr, 2, "");
			if(!(this.op_stage_instr.containsKey(BNode.RdInstr) && this.op_stage_instr.get(BNode.RdInstr).containsKey(2))) {
				rdInstr_2 = language.CreateLocalNodeName(BNode.RdInstr, 2, "");
				language.UpdateInterface(topModule, BNode.RdInstr,  "", 2, false, false);
			}
			addLogic("assign ISAX_isisax_2 ="+language.CreateAllEncoding(allISAXes, ISAXes, rdInstr_2)+";\n");
		}
	}
	
	private void IntegrateISAX_RdInstr() {
		if(this.op_stage_instr.containsKey(BNode.RdInstr) || this.op_stage_instr.containsKey(BNode.RdIValid)) {
			boolean declare  = false; 
			for(int stage=this.picorv32.maxStage;stage>=0;stage--)
				if(( (this.op_stage_instr.containsKey(BNode.RdInstr)  && this.op_stage_instr.get(BNode.RdInstr).containsKey(stage)) || (this.op_stage_instr.containsKey(BNode.RdIValid)  && this.op_stage_instr.get(BNode.RdIValid).containsKey(stage))  || declare) && !this.rdInstrDeclared.contains(stage)) {
					rdInstr(stage);
					declare = true;
				}
					
		}
	}
	
	
	private void IntegrateISAX_RdIValid() {
		if(this.op_stage_instr.containsKey(BNode.RdIValid)) {
			for(int stage=0;stage<=this.picorv32.maxStage;stage++)
				if( this.op_stage_instr.get(BNode.RdIValid).containsKey(stage)) 
					for(String instr :  this.op_stage_instr.get(BNode.RdIValid).get(stage)) 
						if(!this.iValidDeclared.get(stage).contains(instr))
							this.checkIVlalid(stage, instr);
		}
	}
	
	private void IntegrateISAX_WrStall() {
		String spawnStall = "";
		if(this.op_stage_instr.containsKey(BNode.WrRD_spawn)) {
			spawnStall += BNode.ISAX_spawnStall_regF_s; 
			this.addLogic("assign "+BNode.ISAX_spawnStall_regF_s+" = ("+BNode.ISAX_fire_regF_reg+" && (cpu_state == cpu_state_ld_rs1)) || ("+BNode.ISAX_fire2_regF_reg+");");

		}
		if(this.op_stage_instr.containsKey(BNode.WrMem_spawn) || this.op_stage_instr.containsKey(BNode.RdMem_spawn)) {
			spawnStall = language.OpIfNEmpty(spawnStall, " || ");
			spawnStall += BNode.ISAX_spawnStall_mem_s; 
			this.addLogic("assign "+BNode.ISAX_spawnStall_mem_s+" = ("+BNode.ISAX_fire_mem_reg+" && (cpu_state == cpu_state_ld_rs1)) || ("+BNode.ISAX_fire2_mem_reg+") || (mem_state_spawn!=0);");

		}
		if(!spawnStall.isEmpty())
			spawnStall += " || ";
		if(this.op_stage_instr.containsKey(BNode.WrStall) ){
			if(this.op_stage_instr.get(BNode.WrStall).containsKey(2))
				toFile.UpdateContent(this.ModFile("picorv32"),"cpu_state <= cpu_state_fetch;", new ToWrite("if(!"+language.CreateNodeName(BNode.WrStall, 2,"")+")cpu_state <= cpu_state_fetch;",true,false,"latched_is_lu: reg_out <= mem_rdata_word;"));
			if(this.op_stage_instr.get(BNode.WrStall).containsKey(1)) {
				toFile.ReplaceContent(this.ModFile("picorv32"),"if (mem_do_prefetch || mem_do_rinst || mem_do_rdata) begin", new ToWrite("if ((mem_do_prefetch || mem_do_rinst || mem_do_rdata) && (!("+spawnStall+" "+language.CreateNodeName(BNode.WrStall, 1,"")+") || (cpu_state != cpu_state_ld_rs1))) begin",false,true,""));
				toFile.UpdateContent(this.ModFile("picorv32"),"endcase", new ToWrite("if ("+spawnStall+" "+language.CreateNodeName(BNode.WrStall, 1,"")+") cpu_state <= cpu_state_ld_rs1;",true,false,"cpu_state <= cpu_state_ld_rs2;"));				
			}
			if(this.op_stage_instr.get(BNode.WrStall).containsKey(0)) {
				//toFile.UpdateContent(this.ModFile("picorv32"),"cpu_state <= cpu_state_fetch;", new ToWrite("if(!"+language.CreateNodeName(BNode.WrStall, 0,"")+")cpu_state <= cpu_state_fetch;",true,false,"latched_is_lu: reg_out <= mem_rdata_word;"));
				toFile.UpdateContent(this.ModFile("picorv32"),"end",new ToWrite("if("+language.CreateNodeName(BNode.WrStall, 0,"")+")\n"+tab+"cpu_state <= cpu_state_fetch;",true,false,"cpu_state <= cpu_state_ld_rs1;"));
			
			}
		}
		if(!ContainsOpInStage(BNode.WrStall,1) && !spawnStall.isEmpty()) {
			toFile.ReplaceContent(this.ModFile("picorv32"),"if (mem_do_prefetch || mem_do_rinst || mem_do_rdata) begin", new ToWrite("if ((mem_do_prefetch || mem_do_rinst || mem_do_rdata) && (!("+spawnStall+") || (cpu_state != cpu_state_ld_rs1)) ) begin",false,true,""));
			toFile.UpdateContent(this.ModFile("picorv32"),"endcase", new ToWrite("if ("+spawnStall+") cpu_state <= cpu_state_ld_rs1;",true,false,"cpu_state <= cpu_state_ld_rs2;"));				
		
		}
			
	}
	
	private void IntegrateISAX_WrRD() {
		if(this.op_stage_instr.containsKey(BNode.WrRD)) {
			String isax_wrrd_0_s = "isax_wrrd_0_r";
			String isax_wrrd_s = "isax_wrrd_r";
			int stage = this.picorv32.GetNodes().get(BNode.WrRD).GetLatest();
			toFile.UpdateContent(this.ModFile("picorv32"),"case (1'b1)",new ToWrite(isax_wrrd_s+": begin\n"+ tab + "cpuregs_wrdata = "+language.CreateNodeName(BNode.WrRD, this.picorv32.GetNodes().get(BNode.WrRD).GetLatest(), "")+";\n"+ tab + "cpuregs_write = 1;\n"+ "end ",true,false,"cpuregs_wrdata = 'bx;"));
			this.addDeclaration("reg "+isax_wrrd_s+", "+isax_wrrd_0_s+";\n");
			
			String behav = "\n"
					+ "always @(posedge "+language.clk+")begin \n"
					+ tab +"isax_wrrd_0_r <=  "+language.CreateValidEncoding(this.op_stage_instr.get(BNode.WrRD).get(stage), ISAXes, "mem_rdata_latched", BNode.WrRD)+";\n"
					+ tab + "if ((cpu_state ==  cpu_state_fetch) && (decoder_trigger)) isax_wrrd_r <= isax_wrrd_0_r;\n"
					+ "end";

			this.addLogic(behav);
		}
		/*
		if(this.op_stage_instr.containsKey(BNode.WrRD)) {
			String isax_wrrd_s = "isax_wrrd_r";
			int stage = this.picorv32.GetNodes().get(BNode.WrRD).GetLatest();
			toFile.UpdateContent(this.ModFile("picorv32"),"case (1'b1)",new ToWrite(isax_wrrd_s+": begin\n"+ tab + "cpuregs_wrdata = "+language.CreateNodeName(BNode.WrRD, this.picorv32.GetNodes().get(BNode.WrRD).GetLatest(), "")+";\n"+ tab + "cpuregs_write = 1;\n"+ "end ",true,false,"cpuregs_wrdata = 'bx;"));
			this.addDeclaration("reg "+isax_wrrd_s+";\n");
			String instr = language.CreateNodeName(BNode.RdInstr,stage- 1, "");
			if(!(this.op_stage_instr.containsKey(BNode.RdInstr) && this.op_stage_instr.get(BNode.RdInstr).containsKey(stage-1))) {
				this.rdInstr(stage-1);
				instr = language.CreateLocalNodeName(BNode.RdInstr, stage-1, "");
			}
			this.addLogic("always @(posedge "+language.clk+") "+isax_wrrd_s+" <= "+language.CreateValidEncoding(this.op_stage_instr.get(BNode.WrRD).get(stage), ISAXes, instr, BNode.WrRD)+";");
		}*/
	}
	
	
	private void IntegrateISAX_SpawnRD (){
		int spawnStage = this.picorv32.maxStage+1;
		String priority = "";
		String spawnRegs = "";
		String toDeclare = "";
		String isaxFire =  BNode.ISAX_fire_regF_reg;
		String isaxFire2 = BNode.ISAX_fire2_regF_reg;
		String current_spawn_addr = "assign current_spawn_addr = ";
		String current_spawn_data = "assign current_spawn_data = ";
		if(op_stage_instr.containsKey(BNode.WrRD_spawn)) {
			// Write declarations 
			toDeclare += language.CreateSpawnDeclareSigs(op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage), spawnStage, BNode.WrRD_spawn,true, 0);			
			toDeclare +=  "wire [32 -1:0]       current_spawn_data;\n"
					+ "wire  [5 -1:0]       current_spawn_addr;\n";
			addDeclaration(toDeclare);
			
			// Logic
			for(String ISAX : op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage)) {
				spawnRegs   += language.CreateSpawnRegsLogic(ISAX, spawnStage, priority,BNode.WrRD_spawn, "");
				if(!priority.isEmpty())
					priority += " || ";
				if((op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage).size()>1)) {
					current_spawn_addr += "(" + language.CreateNodeName(BNode.WrRD_spawn_valid, spawnStage,ISAX).replace("_i", "_reg") + " ? "+language.CreateDeclReg(BNode.WrRD_spawn_addr, spawnStage, ISAX)+ ": "; 
					current_spawn_data += "(" + language.CreateNodeName(BNode.WrRD_spawn_valid, spawnStage,ISAX).replace("_i", "_reg") + " ? "+language.CreateDeclReg(BNode.WrRD_spawn, spawnStage, ISAX)+ ": "; 
				} else {
					current_spawn_addr +=language.CreateNodeName(BNode.WrRD_spawn_addr, spawnStage, ISAX).replace("_i", "_reg")+";\n";
					current_spawn_data += language.CreateNodeName(BNode.WrRD_spawn, spawnStage, ISAX).replace("_i", "_reg")+";\n";
				}
				priority   += language.CreateNodeName(BNode.WrRD_spawn_valid, spawnStage,ISAX).replace("_i", "_reg");
			}
			if(op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage).size()>1) {
				current_spawn_addr += "0"+")".repeat(op_stage_instr.get(BNode.WrRD_spawn_addr).get(spawnStage).size()-1)+";\n";
				current_spawn_data += "0"+")".repeat(op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage).size()-1)+";\n";
			}
			spawnRegs = language.CreateInAlways(true,spawnRegs)+"\n";
			addLogic(spawnRegs);;;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			addLogic(current_spawn_addr+current_spawn_data);
			String allSpawn_OR ="assign "+ BNode.ISAX_fire_regF_s+" = "+ language.allISAXNameText(" || ",BNode.WrRD_spawn_valid+"_", "_"+spawnStage+"_i", op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage))+";\n";
			String allSpawn_SUM = "assign " + BNode.ISAX_sum_spawn_regF_s +" = "+language.allISAXNameText(" + ",BNode.WrRD_spawn_valid+"_", "_"+spawnStage+"_reg", op_stage_instr.get(BNode.WrRD_spawn).get(spawnStage))+";\n";
			
			String fire_logic = language.CommitSpawnFire(BNode.WrRD_spawn,  "","(cpu_state == cpu_state_ld_rs1)", spawnStage,"");
			this.addLogic(fire_logic +"\n"+ allSpawn_OR  +"\n"+  allSpawn_SUM +"\n");
			toFile.ReplaceContent(this.ModFile("picorv32"),"if (cpu_state == cpu_state_fetch)",new ToWrite("if ((cpu_state == cpu_state_fetch) || ("+isaxFire2+")) begin",true,false,"cpuregs_wrdata = 'bx;"));
			toFile.UpdateContent(this.ModFile("picorv32"),"case (1'b1)",new ToWrite("("+isaxFire2+"): begin\n"+ tab + "cpuregs_wrdata = current_spawn_data;\n"+ tab + "cpuregs_write = 1;\n"+ "end ",true,false,"cpuregs_wrdata = 'bx;"));
			String commit = " begin if("+isaxFire2+")\n"
					+ tab + "cpuregs[current_spawn_addr] <= cpuregs_wrdata;\n"
					+ "else\n"
					+ tab + "cpuregs[latched_rd] <= cpuregs_wrdata;\n"
					+ "end";
			toFile.ReplaceContent(this.ModFile("picorv32"),"cpuregs[latched_rd] <= cpuregs_wrdata;",new ToWrite("\n",false,true,""));
			toFile.UpdateContent(this.ModFile("picorv32"),"`else",new ToWrite(commit,true,false,"`elsif PICORV32_TESTBUG_002"));
			
		}
	}
	
	private void IntegrateISAX_SpawnMem() {
		String toDeclare = "";
		int spawnStage = this.picorv32.maxStage+1;
		if(op_stage_instr.containsKey(BNode.WrMem_spawn) || op_stage_instr.containsKey(BNode.RdMem_spawn)) {
			int sizeOthers = 0; 
			if(op_stage_instr.containsKey(BNode.RdMem_spawn)) {
				sizeOthers = op_stage_instr.get(BNode.RdMem_spawn).get(spawnStage).size();
				toDeclare += language.CreateSpawnDeclareSigs(op_stage_instr.get(BNode.RdMem_spawn).get(spawnStage), spawnStage, BNode.RdMem_spawn,false,0);	
			}
			if(op_stage_instr.containsKey(BNode.WrMem_spawn))
					toDeclare += language.CreateSpawnDeclareSigs(op_stage_instr.get(BNode.WrMem_spawn).get(spawnStage), spawnStage, BNode.WrMem_spawn,true,sizeOthers);						
			addDeclaration(toDeclare);
			
			
			// Logic
			HashSet<String> allISAXes = new HashSet<String>(); 
			if(op_stage_instr.containsKey(BNode.RdMem_spawn))
				allISAXes.addAll(op_stage_instr.get(BNode.RdMem_spawn).get(spawnStage));		
			if(op_stage_instr.containsKey(BNode.WrMem_spawn))
				allISAXes.addAll(op_stage_instr.get(BNode.WrMem_spawn).get(spawnStage));
			
			// Sum and fire_s
			if(!allISAXes.isEmpty()) {
				String allSpawn_OR ="assign "+ BNode.ISAX_fire_mem_s+" = "+ language.allISAXNameText(" || ",BNode.Mem_spawn_valid+"_", "_"+spawnStage+"_i",allISAXes)+";\n";
				String allSpawn_SUM = "assign " + BNode.ISAX_sum_spawn_mem_s +" = "+language.allISAXNameText(" + ",BNode.Mem_spawn_valid+"_", "_"+spawnStage+"_reg", allISAXes)+";\n";
				addLogic(allSpawn_OR + allSpawn_SUM);
			}
			
			// Stall 
			// in wrStall function
			
			// Commit logic
			String priority   = "";
			String spawnLogic = "";
			String spawnCommit = "";
			String spawnSetFSM = "";
			String[] nodes = {BNode.RdMem_spawn,BNode.WrMem_spawn};
			int i= 0 ; 
			for(i=0;i<2;i++)  {
				if( op_stage_instr.containsKey(nodes[i])) {
					for(String ISAX : op_stage_instr.get(nodes[i]).get(spawnStage)) {
						spawnCommit += language.CreateSpawnCommitMem(ISAX, spawnStage, priority,nodes[i],"mem_ready && mem_valid","mem_rdata");
						spawnLogic  += language.CreateSpawnRegsLogic(ISAX, spawnStage,priority, nodes[i], "mem_state_spawn");
						spawnSetFSM += language.CreateSpawnFSMMem(ISAX, spawnStage,priority, nodes[i],"spawn_mem_wr","spawn_mem_wdata", "spawn_mem_addr" );
						
						// TODO
						if(op_stage_instr.get(nodes[i]).get(spawnStage).size()==1) {				
						}
						if(!priority.isEmpty())
							priority += " || ";
						priority   += language.CreateNodeName(BNode.Mem_spawn_valid, spawnStage,ISAX).replace("_i", "_reg");
					}
				}
			}
			String defaultsFSM = "spawn_mem_wr = 0;\nspawn_mem_addr = 0;\nspawn_mem_wdata = 0;\n";
			addLogic(language.CreateInAlways(true,spawnLogic) +"\n"+language.CreateInAlways(true,spawnCommit) +"\n"+ language.CreateInAlways(false,defaultsFSM) +"\n"+ language.CreateInAlways(false, spawnSetFSM));
		}
		String fire_logic = language.CommitSpawnFire(BNode.RdMem_spawn,  "","(cpu_state == cpu_state_ld_rs1) && (mem_state==0)", spawnStage,"mem_state_spawn"); 
		addLogic(fire_logic);
		addDeclaration("reg spawn_mem_wr, mem_state_spawn;\nreg [31:0] spawn_mem_wdata, spawn_mem_addr;\n ");
		String mem_FSM = "if("+BNode.ISAX_fire2_mem_reg+") begin "
				+ "case (mem_state_spawn)\n"
				+ "	0: begin\n"
				+ "		if ("+BNode.ISAX_fire2_mem_reg+") begin\n"
				+ "			mem_valid <= 1;\n"
				+ "			mem_addr <= spawn_mem_addr;\n"
				+ "			mem_wstrb <= mem_la_wstrb & {4{spawn_mem_wr}};\n"
				+ "			mem_wdata <= spawn_mem_wdata;\n"
				+ "		    mem_state_spawn <= 1;\n"
				+ "         mem_instr <= 0;"
				+ "			\n"
				+ "		end\n"
				+ "	end\n"
				+ "	1: begin\n"
				+ "		if (mem_valid && mem_ready) begin\n"
				+ "				mem_valid <= 0;\n"
				+ "				mem_la_secondword <= 0;\n"
				+ "				\n"
				+ "				mem_state_spawn <= 0;\n"
				+ "		end\n"
				+ "	end\n"
				+ "endcase\n"
				+ "end\n"
				+ "if("+language.reset+")\n"
				+ " mem_state_spawn <=0;\n"
				+ "\n";
		toFile.UpdateContent(this.ModFile("picorv32"), "if (clear_prefetched_high_word)",new ToWrite(mem_FSM, false, true, "", true));
		
	}

	private void IntegrateISAX_Mem() {
		int stage = this.picorv32.GetNodes().get(BNode.WrMem).GetLatest();
		boolean wrMem = this.op_stage_instr.containsKey(BNode.WrMem) && this.op_stage_instr.get(BNode.WrMem).containsKey(stage);
		boolean rdMem = this.op_stage_instr.containsKey(BNode.RdMem) && this.op_stage_instr.get(BNode.RdMem).containsKey(stage);
		
		if(wrMem) {
			String clause = language.CreateValidEncodingIValid(op_stage_instr.get(BNode.WrMem).get(stage), ISAXes, 0, BNode.WrMem);
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_sb    <= is_sb_sh_sw", new ToWrite("instr_sb    <= (is_sb_sh_sw || ("+clause+")) && mem_rdata_q[14:12] == 3'b000;",false,true,""));
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_sh    <= is_sb_sh_sw", new ToWrite("instr_sb    <= (is_sb_sh_sw || ("+clause+")) && mem_rdata_q[14:12] == 3'b001;",false,true,""));
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_sw    <= is_sb_sh_sw", new ToWrite("instr_sb    <= (is_sb_sh_sw || ("+clause+")) && mem_rdata_q[14:12] == 3'b010;",false,true,""));
			String isaxesNoAddr = "";
			String isaxesWithAddr = "";
			for (String ISAX : this.op_stage_instr.get(BNode.WrMem).get(stage)) {
				checkIVlalid(0,ISAX); //for computing instr_sb, instr_sh..
				checkIVlalid(1,ISAX); // for switching to cpu store state
				checkIVlalid(2,ISAX); // for wdata
				if(!ISAXes.get(ISAX).GetNode(BNode.WrMem).GetAddrInterf()) 
					isaxesNoAddr += ", "+ checkIVlalid(0,ISAX);
				else {
					language.OpIfNEmpty(isaxesWithAddr, "||");
					isaxesWithAddr += checkIVlalid(2,ISAX);
				}
			}
			if(!isaxesWithAddr.isEmpty())
				toFile.ReplaceContent(this.ModFile("picorv32"),"reg_op1 <=",new ToWrite("reg_op1 <= ("+ isaxesWithAddr + ") ? "+ language.CreateNodeName(BNode.Mem_addr, stage, "")+" :  reg_op1 + decoded_imm;",true,false,"cpu_state_stmem: begin"));
			
			if(!isaxesNoAddr.isEmpty())
				toFile.ReplaceContent(this.ModFile("picorv32"),"is_sb_sh_sw:", new ToWrite("|{is_sb_sh_sw, " +isaxesNoAddr+"}:",true,false,"|{instr_jalr,"));
			String validMem = language.CreateValidEncodingIValid(op_stage_instr.get(BNode.WrMem).get(stage), ISAXes, 1, BNode.WrMem);
			if (!validMem.isEmpty())
				toFile.ReplaceContent(this.ModFile("picorv32"),"is_sb_sh_sw", new ToWrite ("is_sb_sh_sw ||" + language.CreateValidEncodingIValid(op_stage_instr.get(BNode.WrMem).get(stage), ISAXes, 1, BNode.WrMem)+": begin",true,false,"default: begin"));
			// Update WDATA with ISAX wdata
			clause = language.CreateValidEncodingIValid(op_stage_instr.get(BNode.WrMem).get(stage), ISAXes, 2, BNode.WrMem);
			toFile.ReplaceContent(this.ModFile("picorv32"),"mem_wdata <= mem_la_wdata;", new ToWrite ("mem_wdata <= ("+clause+") ? "+language.CreateLocalNodeName("isax_"+BNode.WrMem, stage, "")+" : mem_la_wdata;\n",true, false, "if (mem_la_write) begin"));
			this.addLogic("assign "+language.CreateLocalNodeName("isax_"+BNode.WrMem, stage, "")+" = "+ " (mem_wordsize == 0) ? "+language.CreateNodeName(BNode.WrMem, stage, "")+" : ((mem_wordsize == 1) ? {2{"+language.CreateNodeName(BNode.WrMem, stage, "")+"[15:0]}} : {4{"+language.CreateNodeName(BNode.WrMem, stage, "")+"}});\n");
			this.addDeclaration("wire [32 -1:0] "+language.CreateLocalNodeName("isax_"+BNode.WrMem, stage, "")+";\n");
		}
		if(rdMem) {
			String clause = language.CreateValidEncodingIValid(op_stage_instr.get(BNode.RdMem).get(stage), ISAXes,0, BNode.RdMem);
			
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_lb    <= is_lb_lh_lw_lbu_lhu", new ToWrite("instr_lb    <= (is_lb_lh_lw_lbu_lhu || ("+clause+")) && mem_rdata_q[14:12] == 3'b000;", false,true,""));
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_lh    <= is_lb_lh_lw_lbu_lhu", new ToWrite("instr_lh    <= (is_lb_lh_lw_lbu_lhu || ("+clause+")) && mem_rdata_q[14:12] == 3'b001;", false,true,""));
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_lw    <= is_lb_lh_lw_lbu_lhu", new ToWrite("instr_lw    <= (is_lb_lh_lw_lbu_lhu || ("+clause+")) && mem_rdata_q[14:12] == 3'b010;", false,true,""));
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_lbu   <= is_lb_lh_lw_lbu_lhu", new ToWrite("instr_lbu    <= (is_lb_lh_lw_lbu_lhu || ("+clause+")) && mem_rdata_q[14:12] == 3'b100;", false,true,""));
			toFile.ReplaceContent(this.ModFile("picorv32"),"instr_lhu   <= is_lb_lh_lw_lbu_lhu", new ToWrite("instr_lhu    <= (is_lb_lh_lw_lbu_lhu || ("+clause+")) && mem_rdata_q[14:12] == 3'b101;", false,true,""));
			
			String isaxesNoAddr = "";
			String isaxesWithAddr = "";
			for (String ISAX : this.op_stage_instr.get(BNode.RdMem).get(stage)) {
				checkIVlalid(0,ISAX); // for computing instr_lb, instr_lh...
				checkIVlalid(1,ISAX); // for switching to cpu load state 
				if(!ISAXes.get(ISAX).GetNode(BNode.RdMem).GetAddrInterf()) 
					isaxesNoAddr += ", "+ checkIVlalid(0,ISAX);
				else {
					language.OpIfNEmpty(isaxesWithAddr, "||");
					isaxesWithAddr += checkIVlalid(2,ISAX);
				}
			}
			if(!isaxesWithAddr.isEmpty())
				toFile.ReplaceContent(this.ModFile("picorv32"),"reg_op1 <=",new ToWrite("reg_op1 <= ("+ isaxesWithAddr + ") ? "+ language.CreateNodeName(BNode.Mem_addr, stage, "")+" :  reg_op1 + decoded_imm;",true,false,"cpu_state_ldmem: begin"));
			
			if(!isaxesNoAddr.isEmpty())
				toFile.ReplaceContent(this.ModFile("picorv32"),"|{instr_jalr,", new ToWrite("|{instr_jalr, is_lb_lh_lw_lbu_lhu, is_alu_reg_imm" +isaxesNoAddr+"}:",false,true,""));
			String validMem = language.CreateValidEncodingIValid(op_stage_instr.get(BNode.RdMem).get(stage), ISAXes, 1, BNode.RdMem);
			if (!validMem.isEmpty())
				toFile.ReplaceContent(this.ModFile("picorv32"),"is_lb_lh_lw_lbu_lhu && !instr_trap", new ToWrite ("(is_lb_lh_lw_lbu_lhu && !instr_trap) ||" + validMem+": begin",false,true,""));
		}
	}
	
	private void IntegrateISAX_WrPC (){
		// TODO check this
		for(int i=this.picorv32.maxStage;i>0;i--) {
			if(op_stage_instr.containsKey(BNode.WrPC) && op_stage_instr.get(BNode.WrPC).containsKey(i)) {		
				String text = "if("+language.CreateValidEncodingIValid(this.op_stage_instr.get(BNode.WrPC).get(i), ISAXes, i, BNode.WrPC)+" )begin \n"
						+ tab + "mem_do_rinst <= 1; \n"
						+ tab + "reg_next_pc <= "+language.CreateNodeName(BNode.WrPC, i, "")+"; \n"
						+ tab + "cpu_state <= cpu_state_fetch; \n"
						+ "end";
				for(String instr : this.op_stage_instr.get(BNode.WrPC).get(i))
					checkIVlalid(i,instr);
				toFile.UpdateContent(this.ModFile("picorv32"),"end",new ToWrite(text,true,false,"cpu_state <= cpu_state_ld_rs1;"));
			}
		}
		
		if(op_stage_instr.containsKey(BNode.WrPC_spawn))  {
			String spawn  = "if("+language.CreateNodeName(BNode.WrPC_spawn_valid, this.picorv32.maxStage+1, "")+") begin \n"
					+ tab + "mem_do_rinst <= 1; \n"
					+ tab + "reg_next_pc <= "+language.CreateNodeName(BNode.WrPC_spawn, this.picorv32.maxStage+1, "")+"; \n"
					+ tab + "cpu_state <= cpu_state_fetch; \n"
					+ "end";
			toFile.UpdateContent(this.ModFile("picorv32"),"end",new ToWrite(spawn,true,false,"cpu_state <= cpu_state_ld_rs1;"));
		}
	}
		private String checkIVlalid(int stage, String instr) {
			HashMap <Integer, String> andState = new HashMap <Integer, String> ();
			andState.put(0, " && (cpu_state[6] == 1'b1)"); //cpu_state[6] == cpu_state_fetch
			andState.put(1, " && (cpu_state[5] == 1'b1)");
			if(ISAXes.get(instr).HasNode(BNode.RdMem) ) {
				andState.put(2, " && (cpu_state[0] == 1'b1)");
				andState.put(3, " && (cpu_state[0] == 1'b1)");
			} else if(ISAXes.get(instr).HasNode(BNode.WrMem)) {
				andState.put(2, " && (cpu_state[1] == 1'b1)");
				andState.put(3, " && (cpu_state[1] == 1'b1)");
			} else {
				andState.put(2, " && (cpu_state[3] == 1'b1)");
				andState.put(3, " && (cpu_state[3] == 1'b1)");
			}
			
			
			String IValid = language.CreateLocalNodeName(BNode.RdIValid, stage, instr);
			boolean asOut = this.op_stage_instr.containsKey(BNode.RdIValid) && this.op_stage_instr.get(BNode.RdIValid).containsKey(stage) && this.op_stage_instr.get(BNode.RdIValid).get(stage).contains(instr);
			if(asOut)	
				IValid = language.CreateNodeName(BNode.RdIValid, stage, instr);
			if(!this.iValidDeclared.get(stage).contains(instr)) {
				this.iValidDeclared.get(stage).add(instr);
				if(!asOut)					
					addDeclaration(this.NodeDataT(BNode.RdIValid, stage)+" "+language.CreateLocalNodeName(BNode.RdIValid, stage, instr)+";\n");
				if(!this.rdInstrDeclared.contains(stage))
					rdInstr(stage);
				if(stage<3) 
					addLogic("assign "+ IValid+ " = "+language.CreateAllEncoding(new HashSet<String>() {{add(instr);}}, ISAXes, language.CreateLocalNodeName(BNode.RdInstr, stage, ""))+andState.get(stage)+";\n" );
				else {
					String IValid_1 = language.CreateLocalNodeName(BNode.RdIValid, stage-1, instr);
					boolean asOut_1 = this.op_stage_instr.containsKey(BNode.RdIValid) && this.op_stage_instr.get(BNode.RdIValid).containsKey(stage-1) && this.op_stage_instr.get(BNode.RdIValid).get(stage-1).contains(instr);
					if(asOut_1)	
						IValid_1 = language.CreateNodeName(BNode.RdIValid, stage-1, instr);
					if(!this.iValidDeclared.get(stage-1).contains(instr)) {
						this.iValidDeclared.get(stage-1).add(instr);					
						if(!asOut)					
							addDeclaration(this.NodeDataT(BNode.RdIValid, stage-1)+" "+language.CreateLocalNodeName(BNode.RdIValid, stage-1, instr)+";\n");
						if(!this.rdInstrDeclared.contains(stage-1))
							rdInstr(stage-1);
					}
					addLogic("assign "+ IValid_1+ " = "+language.CreateAllEncoding(new HashSet<String>() {{add(instr);}}, ISAXes, language.CreateLocalNodeName(BNode.RdInstr, stage-1, ""))+andState.get(stage-1)+";\n" );
					addLogic("always @(posedge "+language.clk+")\n"+tab+ IValid+" <="+IValid_1+";\n");
			
				}
			}
			return IValid;
		}
	private void rdInstr(int stage) {
		String text = "";
		if(stage==0 && !this.rdInstrDeclared.contains(0)) {
			text = "always @(posedge "+language.clk+") begin \n"
					+ "		if (mem_do_rinst && mem_done) \n"
					+ "			rdInstr_0_r <= mem_rdata_latched;\n"
					+ "	end\n "
					+ "wire [32 -1:0] "+language.CreateLocalNodeName(BNode.RdInstr, 0, "")+";\n"
					+ "assign "+language.CreateLocalNodeName(BNode.RdInstr,0, "")+" = rdInstr_0_r;";
			addDeclaration("reg [32 -1:0] rdInstr_0_r;\n");
			this.rdInstrDeclared.add(0);
		}
		if(stage==1 && !this.rdInstrDeclared.contains(1)) {
			text = "always @(posedge "+language.clk+") begin \n"
					+ "		if ((cpu_state ==  cpu_state_fetch) && (decoder_trigger))\n"
					+ "			rdInstr_1_r <= rdInstr_0_r;\n"
					+ "	end \n"
					+ "wire [32 -1:0] "+language.CreateLocalNodeName(BNode.RdInstr, 1, "")+";\n"
					+ "assign "+language.CreateLocalNodeName(BNode.RdInstr, 1, "")+" = rdInstr_1_r;\n";
			addDeclaration("reg [32 -1:0] rdInstr_1_r;\n");
			this.rdInstrDeclared.add(1);
		} else if(stage ==  2 && !this.rdInstrDeclared.contains(2)) {
			text = "always @(posedge "+language.clk+") begin \n"
					+ "		if  ((cpu_state !=  cpu_state_fetch) && (cpu_state !=  cpu_state_ld_rs1))  \n"
					+ "			rdInstr_2_r <= rdInstr_1_r;\n"
					+ "	end \n"
					+ "wire [32 -1:0] "+language.CreateLocalNodeName(BNode.RdInstr, 2, "")+";\n"
					+ "assign "+language.CreateLocalNodeName(BNode.RdInstr, 2, "")+" = ((cpu_state !=  cpu_state_fetch) && (cpu_state !=  cpu_state_ld_rs1)) ? rdInstr_1_r :  rdInstr_2_r;\n";
			addDeclaration("reg [32 -1:0]  rdInstr_2_r;\n");
			//addLogic(text);
			this.rdInstrDeclared.add(2);
		}
		addLogic(text);
		
	}
	
	
	
	private void addLogic(String text) {
		toFile.UpdateContent(this.ModFile(topModule),"endmodule",  new ToWrite(text,false,true,"",true,topModule));
	}
	
	private void addDeclaration(String text) {
		toFile.UpdateContent(this.ModFile(topModule),");",  new ToWrite(text,true,false,"module picorv32",false,topModule));
		
	}
	
	private boolean ContainsOpInStage(String operation, int stage) {
		return op_stage_instr.containsKey(operation) && op_stage_instr.get(operation).containsKey(stage);
	}
	private void ConfigPicoRV32 () {
	 	this.PopulateNodesMap(this.picorv32.maxStage);
		PutModule(pathPicoRV32+"\\picorv32.v","picorv32"				, pathPicoRV32+"\\picorv32.v", 			   "",		   "picorv32");
	 	Module newModule = new Module();
	 	newModule.name = "extension_name";

	 	
	 	int spawnStage = this.picorv32.maxStage+1;
	 	for(int i =0; i<spawnStage;i++) {
	 		this.PutNode(32, true, " ", "", "picorv32", BNode.WrPC,i);
	 		this.PutNode(1, true, " ", "", "picorv32", BNode.WrPC_valid,i);
	 	}
	 	this.PutNode(32, true, " ", "", "picorv32", BNode.WrPC_spawn,spawnStage);
 		this.PutNode(1, true, " ", "", "picorv32", BNode.WrPC_spawn_valid,spawnStage);
 		
	 	this.PutNode(32, false, " ", "(cpu_state ==  cpu_state_fetch) ? reg_next_pc : reg_pc", "picorv32", BNode.RdPC,0);
	 	this.PutNode(32, false, " ", "reg_pc", "picorv32", BNode.RdPC,1);
	 	this.PutNode(32, false, " ", "reg_pc", "picorv32", BNode.RdPC,2);
	 	this.PutNode(32, false, " ", "reg_pc", "picorv32", BNode.RdPC,3);
 		
	 	this.PutNode(32, false, " ", "(cpu_state ==  cpu_state_fetch) ? mem_rdata_latched :  rdInstr_1_r", "picorv32", BNode.RdInstr,0);
	 	this.PutNode(32, false, " ", language.CreateLocalNodeName(BNode.RdInstr,1, ""), "picorv32", BNode.RdInstr,1);
	 	this.PutNode(32, false, " ", language.CreateLocalNodeName(BNode.RdInstr, 2, ""), "picorv32", BNode.RdInstr,2);
	 	this.PutNode(32, false, " ", "", "picorv32", BNode.RdInstr,4);
 		
	 	this.PutNode(32, false, "", "cpuregs_rs1", "picorv32", BNode.RdRS1,1); 
	 	this.PutNode(32, false, "reg", "cpuregs_rs1", "picorv32", BNode.RdRS1,2); // TODO check, as not the same in model 	
	 	this.PutNode(32, false, "reg", "cpuregs_rs1", "picorv32", BNode.RdRS1,3);	 		

	 	this.PutNode(32, false, "", "cpuregs_rs2", "picorv32", BNode.RdRS2,1);
	 	this.PutNode(32, false, "reg", "cpuregs_rs2", "picorv32", BNode.RdRS2,2);	
	 	this.PutNode(32, false, "reg", "cpuregs_rs2", "picorv32", BNode.RdRS2,3);
	 	
	 	this.PutNode(32, true, " ", "", "picorv32", BNode.WrRD,3); 
	 	this.PutNode(32, true, " ", "", "picorv32", BNode.WrRD_addr,3);
	 	this.PutNode(32, true, " ", "", "picorv32", BNode.WrRD_valid,3);
	 	
	 	this.PutNode(1,  false, "wire", "", "picorv32", BNode.RdIValid,0);	 		
	 	this.PutNode(1,  false, "wire", "", "picorv32", BNode.RdIValid,1);	 		
	 	this.PutNode(1,  false, "wire", "", "picorv32", BNode.RdIValid,2);	 		
	 	this.PutNode(1,  false, "reg", "", "picorv32", BNode.RdIValid,3);	 		
	 	this.PutNode(1,  false, "reg", "", "picorv32", BNode.RdIValid,4);
	 	
		int stageMem = this.picorv32.GetNodes().get(BNode.RdMem).GetLatest();
	 	this.PutNode(32, false, " ", "mem_rdata", "picorv32", BNode.RdMem,stageMem);
	 	this.PutNode(1,  false, " ", "mem_ready & !mem_instr & (mem_wstrb==0)", "picorv32", BNode.RdMem_valid,stageMem);
	 	this.PutNode(32, true,  " ", "", "picorv32", BNode.WrMem,stageMem);
	 	this.PutNode(1,  true,  " ", "", "picorv32", BNode.Mem_valid,stageMem);
	 	this.PutNode(32, true,  " ", "", "picorv32", BNode.Mem_addr,stageMem);
	 
	 	this.PutNode(1,  false, " ", "!(decoder_trigger)", "picorv32", BNode.RdStall,0);
	 	this.PutNode(1,  false, " ", "(cpu_state !=  cpu_state_ld_rs1)", "picorv32", BNode.RdStall,1);
	 	this.PutNode(1,  false, " ", "((cpu_state_exec ==  cpu_state) && (((TWO_CYCLE_ALU || TWO_CYCLE_COMPARE) && (alu_wait || alu_wait_2))) || (is_beq_bne_blt_bge_bltu_bgeu && !mem_done)) || ((mem_do_prefetch || mem_done) && ((cpu_state == cpu_state_stmem ) ||(cpu_state == cpu_state_ldmem ) )) || (cpu_state ==  cpu_state_fetch) || (cpu_state ==  cpu_state_ld_rs1)", "picorv32", BNode.RdStall,2);
		
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrStall,0);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrStall,1);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrStall,2);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrStall,3);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrStall,4);
	 	
	 	this.PutNode(1, false, " ", "latched_branch && (!instr_jal)", "picorv32", BNode.RdFlush,0);
	 	this.PutNode(1, false, " ", "0", "picorv32", BNode.RdFlush,1);
	 	this.PutNode(1, false, " ", "0", "picorv32", BNode.RdFlush,2);
	 	this.PutNode(1, false, " ", "0", "picorv32", BNode.RdFlush,3);
	 	this.PutNode(1, false, " ", "0", "picorv32", BNode.RdFlush,4);
	 	
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrFlush,0);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrFlush,1);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrFlush,2);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrFlush,3);
	 	this.PutNode(1, true, " ", "", "picorv32", BNode.WrFlush,4);
	 	
	 	
	 	this.PutNode(32, true, " ", "", "picorv32", BNode.WrRD_spawn,spawnStage);
	 	this.PutNode(1,  true, " ", "", "picorv32", BNode.WrRD_spawn_valid,spawnStage);
	 	this.PutNode(5,  true, " ", "", "picorv32", BNode.WrRD_spawn_addr,spawnStage);

	 	this.PutNode(32, false, "reg", "", "picorv32", BNode.RdMem_spawn,spawnStage);
	 	this.PutNode(1, false, "reg","","picorv32", BNode.RdMem_spawn_valid,spawnStage);
	 	this.PutNode(32, true,  " ", "", "picorv32", BNode.WrMem_spawn,spawnStage);
	 	this.PutNode(1, false, "reg","","picorv32",BNode.WrMem_spawn_valid,spawnStage);
	 	this.PutNode(1,  true, " ", "", "picorv32", BNode.Mem_spawn_valid,spawnStage);
	 	this.PutNode(32, true,  " ", "","picorv32", BNode.Mem_spawn_addr,spawnStage);
	 	
	 	this.PutNode(1, false,  " ",BNode.ISAX_fire2_regF_reg,"picorv32", BNode.commited_rd_spawn_valid,spawnStage);
	 	this.PutNode(5, false,  " ","current_spawn_addr", "picorv32",BNode.commited_rd_spawn,spawnStage); // was ISAX_execute_to_rf_select_s
	 	
     }

	
}
